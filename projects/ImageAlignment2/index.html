<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Image Alignment 2 | Dayoon Suh </title> <meta name="author" content="Dayoon Suh"> <meta name="description" content="with Spatial Transformer Networks"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/star16.png?8313f39206cc4c988d004cc656add13a"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://dayoonsuh.github.io/projects/ImageAlignment2/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Dayoon Suh </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">Projects <span class="sr-only">(current)</span> </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Image Alignment 2</h1> <p class="post-description">with Spatial Transformer Networks</p> </header> <article> <h1 id="mathematical-formulation-and-optimization">Mathematical Formulation and Optimization</h1> <h2 id="spatial-transformer-network-and-optimization">Spatial Transformer Network and Optimization</h2> <p>Following the settings of previous post (Image Alignment using Brute Force), our objective function for finding the optimal displacement vector is denoted as:</p> \[dx^*, dy^* = \arg \min_{dx \in X, dy \in Y} L(\text{shift}(A, dx, dy), B)\] <p>where (X) and (Y) are search spaces, (dx) and (dy) represent the shift in the (x) and (y) directions, (L) is the cost metric, and (A) and (B) are image channels.</p> <p>Instead of exhaustively searching for the optimal displacement ((dx, dy)) to align the images, we can use a mathematical operation that shifts the image in a way that can be adjusted and optimized. In this case, we apply <strong>Spatial Transformation</strong>. This approach allows us to express the image shift as a continuous, differentiable operation, which means we can use gradient descent for optimization.</p> <p>For cost metric, we use Means Squared Error (MSE) and Normalized Correlation Coefficient (NCC).</p> <hr> <h2 id="affine-transformation-for-shifting">Affine Transformation for Shifting</h2> <p>The affine transformation matrix for translation can be defined as:</p> \[\theta = \begin{bmatrix} 1 &amp; 0 &amp; dx \\ 0 &amp; 1 &amp; dy \end{bmatrix}\] <p>Since we are only performing translation (without scaling, rotation, or shearing), the only trainable parameters in the matrix are (dx) and (dy). This affine transformation matrix is used to generate a grid of coordinates for the shifted version of the input image (A).</p> <p>Thus, the transformation of a point ((x, y)) using this affine transformation matrix is represented as:</p> \[T_{\theta} = \begin{bmatrix} 1 &amp; 0 &amp; dx \\ 0 &amp; 1 &amp; dy \end{bmatrix} \begin{bmatrix} x \\ y \\ 1 \end{bmatrix}\] <h2 id="optimization-using-gradient-descent">Optimization Using Gradient Descent</h2> <p>To optimize the image alignment, we minimize a given loss function (L) with respect to the displacement parameters (dx) and (dy). The optimization is performed using gradient descent, which iteratively updates the displacement values in the direction that reduces the loss:</p> \[dx_{n+1} = dx_n - \alpha \nabla_{dx}L(\text{shift}(A, dx, dy), B)\] \[dy_{n+1} = dy_n - \alpha \nabla_{dy}L(\text{shift}(A, dx, dy), B)\] <p>where (\alpha) is the learning rate, (n) is the number of iterations, and (\nabla_{dx, dy}L) represents the gradient of the loss function with respect to (dx) and (dy). The image shifting process is performed using bilinear interpolation. This interpolation method provides a more accurate approximation when displacements are not integer values, which helps preserve image quality during the alignment process.</p> <hr> <h3 id="the-gradient-of-dx-is-denoted-as">The gradient of (dx) is denoted as:</h3> \[\frac{\partial A^*[x_i', y_i']}{\partial x_i} = \sum_{n=1}^{H} \sum_{m=1}^{W} A[n, m] \, \max(0, 1 - |y_i - n|) \cdot \begin{cases} 0 &amp; \text{if } |m - x_i| \geq 1 \\ 1 &amp; \text{if } m \geq x_i \\ -1 &amp; \text{if } m \leq x_i \end{cases}\] <hr> <h3 id="the-gradient-of-dy-is-denoted-as">The gradient of (dy) is denoted as:</h3> \[\frac{\partial A^*[x_i', y_i']}{\partial y_i} = \sum_{n=1}^{H} \sum_{m=1}^{W} A[n, m] \, \max(0, 1 - |x_i - m|) \cdot \begin{cases} 0 &amp; \text{if } |n - y_i| \geq 1 \\ 1 &amp; \text{if } n \geq y_i \\ -1 &amp; \text{if } n \leq y_i \end{cases}\] <hr> <p>where (A^*) is the transformed image (A), shifted by (dx) and (dy), (H) and (W) are the height and width of the image, respectively. This process is repeated for (n) iterations.</p> <h1 id="description-of-implementation">Description of Implementation</h1> <h3 id="learning-rate">Learning Rate</h3> <p>Experiments were conducted using three different learning rates: 0.1, 0.01, and 0.001, while keeping the number of optimization steps fixed at 30 for all trials. Among these, the learning rate of 0.001 produced the best overall alignment results. Both the learning rates of 0.01 and 0.001 demonstrated comparable performance in terms of alignment quality, but the 0.001 learning rate provided better alignment than 0.01.</p> <p>However, When the learning rate was set to 0.1, the performance of the alignment process was significantly poorer. This high learning rate led to suboptimal alignments, suggesting that the updates were too large, causing the optimization to overshoot the optimal solution.</p> <p>In terms of computational speed, execution times across the different learning rate settings did not show notable differences, suggesting that the learning rate had little impact on the computational efficiency of the alignment process.</p> <h2 id="number-of-steps">Number of Steps</h2> <p>Experiments were conducted using two different steps: 30 and 100, with learning rates of 0.01 and 0.001. For the learning rate of 0.001, the alignment quality remained consistent between 30 and 100 steps, indicating that increasing the number of steps did not yield improvement.</p> <p>However, with a learning rate of 0.01, there were some alignment quality differences between step sizes 30 and 100.</p> <p>A significant difference was observed in the execution time between the two step counts. For both the MSE and NCC alignment metrics, the execution time per image was between 0.3 and 0.4 seconds when the step count was set to 30. However, when the step count was increased to 100, the execution time exceeded 1 second per image. This shows that although the alignment quality didn’t improve much with more steps, the computational time increased significantly as the step count increased.</p> <h1 id="colorized-outputs">Colorized Outputs</h1> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/ImageAlignment/results_STN/1_ncc_aligned.png" sizes="95vw"></source> <img src="/assets/img/ImageAlignment/results_STN/1_ncc_aligned.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/ImageAlignment/results_STN/2_ncc_aligned.png" sizes="95vw"></source> <img src="/assets/img/ImageAlignment/results_STN/2_ncc_aligned.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/ImageAlignment/results_STN/3_ncc_aligned.png" sizes="95vw"></source> <img src="/assets/img/ImageAlignment/results_STN/3_ncc_aligned.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/ImageAlignment/results_STN/4_ncc_aligned.png" sizes="95vw"></source> <img src="/assets/img/ImageAlignment/results_STN/4_ncc_aligned.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/ImageAlignment/results_STN/5_ncc_aligned.png" sizes="95vw"></source> <img src="/assets/img/ImageAlignment/results_STN/5_ncc_aligned.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/ImageAlignment/results_STN/6_ncc_aligned.png" sizes="95vw"></source> <img src="/assets/img/ImageAlignment/results_STN/6_ncc_aligned.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p><em>The results are aligned using NCC metric.</em></p> <p><br><br><br> Check out the code <a href="https://github.com/dayoonsuh/Image-Alignment" rel="external nofollow noopener" target="_blank">here</a>!</p> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Dayoon Suh. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> </body> </html>